<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Evolution of Life</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="assets/main.css">
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.14/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.14/"></script>

    <script>
require(["esri/Map",
         "esri/views/MapView",
         "esri/layers/ImageryLayer",
         "esri/layers/support/MosaicRule",
         "esri/layers/GraphicsLayer",
         "esri/Graphic",
         "esri/geometry/Point"], 
function(Map, 
         MapView,
         ImageryLayer,
         MosaicRule,
         GraphicsLayer,
         Graphic,
         Point) {

/*START ALL USER CODE HERE*/
    /* SHARED GLOBALS SECTION */

    var gameStarted = false;
    var realTimeElapsedS = 0;
    var historicTimeElapsedMillBCE = -4000;
    var currentLayerIndex = 41;

    function setTimeSliderValue(val){
        document.querySelector('input[type=range]').value = val;
    }
    
    function updateLayer(){
        console.log("Layer updated");
        console.log(currentLayerIndex);
        var oldLayerHs = map.findLayerById("plate-tetonics-200-mil-hs-"+(currentLayerIndex+1));
        var oldLayerP = map.findLayerById("plate-tetonics-200-mil-"+(currentLayerIndex+1));
        var newLayerHs = new ImageryLayer({
          id: "plate-tetonics-200-mil-hs-"+currentLayerIndex,
          url: "https://apl.esri.com/apl3/rest/services/Paleo_200_2_now_hs/ImageServer",
          mosaicRule: new MosaicRule({
              lockRasterIds: [currentLayerIndex,],
              method: "lock-raster",
              ascending: false}),
         opacity:0.1
        });
        var newLayerP = new ImageryLayer({
          id: "plate-tetonics-200-mil-"+currentLayerIndex,
          url: "https://apl.esri.com/apl3/rest/services/P_200_0/ImageServer",
          mosaicRule: new MosaicRule({
              lockRasterIds: [currentLayerIndex,],
              method: "lock-raster",
              ascending: false}),
          opacity:1,
        });

        //map.layers.addMany(newLayerHs, newLayerP);
        map.layers.add(newLayerP, 0);
        map.layers.add(newLayerHs, 1);
       

       
       // Do the cleanup of the old layers after the new ones have loaded
        newLayerHs.load().then((_) => {
            setTimeout(function(){
                map.remove(oldLayerHs);
            }, 1000);
        }).catch((err) => {
            console.log("Error on loading newLayerHs");
            console.log(err);
        });
        
        newLayerP.load().then((_) => {
            setTimeout(function(){
                map.remove(oldLayerP);
                
            }, 1000);
        }).catch((err) => {
            console.log("Error on loading newLayerP");
            console.log(err);
        });
       
//       // Stop the interval when it is done
//        if(i<0){
//            console.log("Clearing 200Mil to present interval");
//            clearInterval(intervalUpdate200MilToPresent);
//        }
        
    }
    
    
    //TODO: Make this timer start only on the start of the game
    function setInitialLayer(){
        var initialLayerHs = new ImageryLayer({
          id: "plate-tetonics-200-mil-hs-"+currentLayerIndex,
          url: "https://apl.esri.com/apl3/rest/services/Paleo_200_2_now_hs/ImageServer",
          mosaicRule: new MosaicRule({
              lockRasterIds: [currentLayerIndex,],
              method: "lock-raster",
              ascending: false}),
         opacity:0.1
        });
        var newLayerP = new ImageryLayer({
          id: "plate-tetonics-200-mil-"+currentLayerIndex,
          url: "https://apl.esri.com/apl3/rest/services/P_200_0/ImageServer",
          mosaicRule: new MosaicRule({
              lockRasterIds: [currentLayerIndex,],
              method: "lock-raster",
              ascending: false}),
          opacity:1,
        });

        //map.layers.addMany(newLayerHs, newLayerP);
        map.layers.add(newLayerP, 0);
        map.layers.add(initialLayerHs, 1);
    }
    const tickMs = 50;
    function startGame(){
        gameStarted = true;
        setInitialLayer();
        setTimeout(function() {
            startSliderAndUpdatingLayer();          
        }, 2000);
    }
    function startSliderAndUpdatingLayer(){
        if(gameStarted) {
            var twelver = 0;
            var globalTimerInterval = setInterval(function() {
                if(historicTimeElapsedMillBCE >=0){
                    return;
                }
                realTimeElapsedS += (tickMs / 1000);
                if(historicTimeElapsedMillBCE < -500){ 
                    // go from 4bil -> 500 mill in ~ 20 seconds
                    var magicLogMultipl = 0.995;
                    historicTimeElapsedMillBCE = historicTimeElapsedMillBCE *
                        magicLogMultipl;}
                else{
                    // go from 500 mill -> 0 in 40 seconds
                    historicTimeElapsedMillBCE += 0.63;
                    twelver += 1
                    if(twelver%19 == 0){
                        twelver = 0;
                        currentLayerIndex--;
                        updateLayer();
                    }
                }
                setTimeSliderValue(historicTimeElapsedMillBCE);
                console.log(historicTimeElapsedMillBCE);

            }, tickMs);}
    }

    var map = new Map({
          basemap: "streets",
        });

    var view = new MapView({
          container: "mapViewDiv",
          map: map,
          zoom: 3,
          center: [0,0] // longitude, latitude
        });    

    /* END SHARED GLOBALS SECTION*/

    /*GAME STATS DIV SECTION*/

    //some functions here

    /* END GAME STATS DIV SECTION*/

    /* ARCGIS JS API SECTION*/
    /* PLATE TETONICS SECTION */

    startGame();


    /* END PLATE TETONICS SECTION*/
    /* LAND/SEA GRAPHICS LAYER SECTION*/

    //Add graphics code here
    let graphicsLayer = new GraphicsLayer({"id":"land-graphics-layer"});

    view.on(["click"], function(event) {
        var mapPoint = event.mapPoint;

        console.log("Point clicked    " + mapPoint.x + "," + mapPoint.y);

        var point = {
          type: "point", // autocasts as new Point()
          x: mapPoint.x,
          y: mapPoint.y,
        };

        markerSymbol = {
          type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
          color: [226, 119, 40],
          outline: {
            // autocasts as new SimpleLineSymbol()
            color: [1, 1, 1],
            width: 10
          }
        };

        var pointGraphic = new Graphic({
          geometry: point,
          symbol: markerSymbol
        });

        map.findLayerById("land-graphics-layer").add(pointGraphic);
        //graphicsLayer.graphics.add(pointGraphic); 
    });


var point = {
          type: "point", // autocasts as new Point()
          x: 0,
          y: 0,
        };

markerSymbol = {
          type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
          color: [226, 119, 40],
          outline: {
            // autocasts as new SimpleLineSymbol()
            color: [1, 1, 1],
            width: 10
          }
};

        var pointGraphic = new Graphic({
          geometry: point,
          symbol: markerSymbol
        });

        graphicsLayer.graphics.add(pointGraphic);

/*
    view.on("click", function(evt) {
        var screenPoint = evt.screenPoint;

        console.log("Point clicked" + str(screenPoint.x) + "," + str(screenPoint.y));

        var point = {
          type: "point", // autocasts as new Point()
          x: screenPoint.x,
          y: screenPoint.y,
        };

        markerSymbol = {
          type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
          color: [226, 119, 40],
          outline: {
            // autocasts as new SimpleLineSymbol()
            color: [1, 1, 1],
            width: 10
          }
        };

        var pointGraphic = new Graphic({
          geometry: point,
          symbol: markerSymbol
        });

        layer.graphics.add(pointGraphic); 
      });
*/
    map.layers.add(graphicsLayer,30);
    /* END LAND/SEA GRAPHICS LAYER SECTION*/
    /* END ARCGIS JS API SECTION */
  });
/*END ALL USER CODE*/
var i = 0;
setInterval(function(){
}, 1000);    </script>
  </head>

  <body>
    <div id="container">
        
        <div id="gameStatsDiv">
            <div style="width:100%;height:10%;">  <input type="range" min="-4000" max="0" value="-4000" class="myslider"></div>
            <div id="mapViewDiv"></div>
            <div id="examplePopup">
                <div id="animalsTab">
                    <div class="animalCardDiv"> <img class="animalCard" src="Jellyfish.png" alt="Jellyfish"></div>
                    <div class="animalCardDiv"> <img class="animalCard" src="Bacteria.png" alt="Jellyfish"></div>
                    <div class="animalCardDiv"> <img class="animalCard" src="Stegosaurus.png" alt="Jellyfish"></div>
                    <div class="animalCardDiv"> <img class="animalCard" src="Stegosaurus.png" alt="Jellyfish"></div>

                </div>
            </div>
        </div>
    </div>
  </body>
</html>
