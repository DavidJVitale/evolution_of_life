<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Evolution of Life</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="assets/main.css">
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.14/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.14/"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
require(["esri/Map",
         "esri/views/MapView",
         "esri/layers/ImageryLayer",
         "esri/layers/support/MosaicRule",
         "esri/layers/GraphicsLayer",
         "esri/Graphic",
         "esri/geometry/Point"], 
function(Map, 
         MapView,
         ImageryLayer,
         MosaicRule,
         GraphicsLayer,
         Graphic,
         Point) {

/*START ALL USER CODE HERE*/
    /* SHARED GLOBALS SECTION */

    var gameStarted = true;
    var realTimeElapsedS = 0;
    var historicTimeElapsedMillBCE = -4000;
    var currentLayerIndex = 41;
    const tickMs = 50;

    var map = new Map({
          basemap: "null",
        });

    var view = new MapView({
          container: "mapViewDiv",
          map: map,
          zoom: 3,
          center: [0,0] // longitude, latitude
        });    

    let graphicsLayer = new GraphicsLayer({"id":"land-graphics-layer"});
    map.layers.add(graphicsLayer,30);
    
    var createdLandLife = [];
    var createdOceanLife = [];
    var lifeForms = [{ name: "Single Cell",
                       isLand: false,
                       isOcean: true,
                       iconUrls: ["assets/icons/Bacteria_Symbol.png"],
                       },
                     { name: "Multi Cell",
                       isLand: true,
                       isOcean: false,
                       iconUrls: ["assets/icons/Fungi_Symbol.png"],
                       },
                     { name: "Algae",
                       isLand: false,
                       isOcean: true,
                       iconUrls: ["assets/icons/Algae_Symbol.png"],
                       },
                     { name: "Jelly Fish",
                       isLand: false,
                       isOcean: true,
                       iconUrls: ["assets/icons/Jellyfish_Symbol.png"],
                       },
                     { name: "Insects",
                       isLand: true,
                       isOcean: false,
                       iconUrls: ["assets/icons/Beetle_Symbol.png"],
                       },
                    { name: "Fish",
                       isLand: false,
                       isOcean: true,
                       iconUrls: ["assets/icons/Shark_Symbol.png"],
                       },
                    { name: "Trees",
                       isLand: true,
                       isOcean: false,
                       iconUrls: ["assets/icons/Fern_Symbol.png"],
                       },
                     { name: "Dinosaurs",
                       isLand: true,
                       isOcean: false,
                       iconUrls: ["assets/icons/Stegosaurus_Symbol.png"],
                       },
                    { name: "Mammals",
                       isLand: true,
                       isOcean: false,
                       iconUrls: ["assets/icons/Pig_Symbol.png"],
                       },
                    { name: "Birds",
                       isLand: true,
                       isOcean: false,
                       iconUrls: ["assets/icons/Parrot_Symbol.png"],
                       },
                    { name: "Primates",
                       isLand: true,
                       isOcean: false,
                       iconUrls: ["assets/icons/Primate_Symbol.png"],
                    }
                    ];
    var extinctions = [{ name: "Cretaceous",
                         value: -65,
                         kill: 17,
                         completed: false
                       },
                       { name: "Triassic",
                         value: -200,
                         kill: 20,
                         completed: false
                       },
                       { name: "Permian",
                         value: -250,
                         kill: 83,
                         completed: false
                       },
                       { name: "Devonian",
                         value: -370,
                         kill: 70,
                         completed: false
                       },
                       { name: "Ordovician",
                         value: -445,
                         kill: 57,
                         completed: false
                       },
                      ];

    var selectedLifeForm = lifeForms[0];
    var getSelectedLifeFormIconUrl = function(){
        return selectedLifeForm.iconUrls[Math.floor(
            Math.random() * selectedLifeForm.iconUrls.length)];
    }

    //Nuts-and-Bolts for Internal Processing
    let internalcounter = 0;
    let creaturesToRemove = [];
    var latestPlateImgLyr = null;
    var checkIsLand = function(mapPoint){
        return new Promise((resolve, reject) => {
            var params = {f: "json",
                          geometryType: "esriGeometryPoint",
                          mosaicRule: JSON.stringify(latestPlateImgLyr.mosaicRule.toJSON()),
                          geometry:  JSON.stringify({spatialReference: {wkid: 4326},
                                                     x: mapPoint.x, y: mapPoint.y}),
                          returnGeometry: "false",
                          returnCatalogItems: "false",
                          returnPixelValues: "true",
                          pixelSize: JSON.stringify({"spatialReference":{"wkid":4326},"x":0.5357142857142857,"y":0.5357142857142857}),
                          maxItemCount: "1"};
            var queryString = $.param(params);
            var myURL = "https://apl.esri.com/apl3/rest/services/P_200_0/ImageServer/identify?"+queryString;
            fetch(myURL).then((data) => {
                     data.json().then((json_) => {
                        var rgbStr = json_.value;
                        var rgbArr = rgbStr.split(",");
                        var r = Number(rgbArr[0]);
                        var g = Number(rgbArr[1]);
                        var b = Number(rgbArr[2]);
                        if(b < 150){
                            resolve(true);
                        } else {
                            resolve(false);
                        }
                    });
                }).catch((err) => {
                    reject(err);
                });;
            });
    }
 

    /* END SHARED GLOBALS SECTION*/

    /*GAME STATS DIV SECTION*/

    //some functions here

    /* END GAME STATS DIV SECTION*/

    /* ARCGIS JS API SECTION*/
    /* PLATE TETONICS SECTION */
    function setTimeSliderValue(val){
        document.querySelector('input[type=range]').value = val;
    }
    function startSliderAndUpdatingLayer(){
        if(gameStarted) {
            var twelver = 0;
            var globalTimerInterval = setInterval(function() {
                if(historicTimeElapsedMillBCE >=0){
                    return;
                }

                realTimeElapsedS += (tickMs / 1000);
                if(historicTimeElapsedMillBCE < -500){ 
                    // go from 4bil -> 500 mill in ~ 20 seconds
                    var magicLogMultipl = 0.995;
                    historicTimeElapsedMillBCE = historicTimeElapsedMillBCE *
                        magicLogMultipl;}
                else{
                    // go from 500 mill -> 0 in 40 seconds
                    historicTimeElapsedMillBCE += 0.63;
                    twelver += 1
                    if(twelver%19 == 0){
                        twelver = 0;
                        if(currentLayerIndex!=2){
                            currentLayerIndex -= 1;
                        }
                        drawLayer();
                    }
                }
                setTimeSliderValue(historicTimeElapsedMillBCE);
                // console.log(historicTimeElapsedMillBCE);
                CheckExtinctions(historicTimeElapsedMillBCE);
                tileRotation();
            }, tickMs);}
    }

function drawLayer(){
   intervalUpdate200MilToPresent = setTimeout(function(){
        var oldLayerHs = map.findLayerById("plate-tetonics-200-mil-hs-"+(currentLayerIndex+1));
        var oldLayerP = map.findLayerById("plate-tetonics-200-mil-"+(currentLayerIndex+1));
        //i -= 1;
        var newLayerHs = new ImageryLayer({
          id: "plate-tetonics-200-mil-hs-"+currentLayerIndex,
          url:
            "https://apl.esri.com/apl3/rest/services/Paleo_200_2_now_hs/ImageServer",
          mosaicRule: new MosaicRule({
              lockRasterIds: [currentLayerIndex,],
              method: "lock-raster",
              ascending: false}),
         opacity:0.1
        });
        var newLayerP = new ImageryLayer({
          id: "plate-tetonics-200-mil-"+currentLayerIndex,
          url:
            "https://apl.esri.com/apl3/rest/services/P_200_0/ImageServer",
          mosaicRule: new MosaicRule({
              lockRasterIds: [currentLayerIndex,],
              method: "lock-raster",
              ascending: false}),
          opacity:1,
        });
        map.layers.add(newLayerP, 0);
        latestPlateImgLyr = newLayerP;
        map.layers.add(newLayerHs, 1);
       
       // Do the cleanup of the old layers after the new ones have loaded
        newLayerHs.load().then((_) => {
            setTimeout(function(){
                map.remove(oldLayerHs);
            }, 1000);
        }).catch((err) => {
            console.log("Error on loading newLayerHs");
            console.log(err);
        });
        
        newLayerP.load().then((_) => {
            setTimeout(function(){
                map.remove(oldLayerP);
                
            }, 1000);
        }).catch((err) => {
            console.log("Error on loading newLayerP");
            console.log(err);
        });
    }, 1);
}
    /* END PLATE TETONICS SECTION*/

    /* GAME ENGINE */
function startGame(){
    gameStarted = true;
    drawLayer()
    setTimeout(function() {
          startSliderAndUpdatingLayer();          
    }, 2000);
}

function CheckExtinctions(sliderTime) {
    for(i = 0; i < extinctions.length; i++) {
      if( sliderTime > extinctions[i].value && !extinctions[i].completed) {
          TriggerExtinction(extinctions[i].kill);
          extinctions[i].completed = true;

          //Set announcements
          AddAnnouncements(i+1);
          //Remove announcement after 10 seconds
          setTimeout(function() {
                        RemoveAnnouncements();          
                  }, 5000);

          // Trigger population explosion after extinction after 3 seconds
          setTimeout(function() {
                      PopulationExplosionAfterExtinctions();          
                  }, 3000);

          
          return;
      } 
    } 
}

function CreateNewPoint(x,y,imageurl) {
    var topPoint = {
                      type: "point", // autocasts as new Point()
                      x: x,
                      y: y,
                   };

    var pictureSymbol = {
                          type: "picture-marker",  // autocasts as new PictureMarkerSymbol()
                          url: imageurl,
                          width: "64px",
                          height: "64px"
                        };

    var pointGraphic = new Graphic({
          geometry: topPoint,
          symbol: pictureSymbol
        });

    return pointGraphic;
}
    function tileRotation(){
        if(Math.floor(historicTimeElapsedMillBCE)===-3512 ){
            console.log("Adding bacteria tile");
            card = document.getElementById("type1")
            card.setAttribute("src","assets/tiles/Bacteria.png")
            card.className += "animalDiv "; 
            card.className += "animalCard"; 
            document.getElementById("type1").addEventListener("click", function(){
              var mapPoint = event.mapPoint;
              selectedLifeForm = lifeForms[0]
            });

        }
        if(Math.floor(historicTimeElapsedMillBCE)===-1506){
            console.log("Adding Multicell tile");
            card = document.getElementById("type2")
            card.setAttribute("src","assets/tiles/Fungi.png")
            card.className += "animalDiv "; 
            card.className += "animalCard"; 
            document.getElementById("type1").addEventListener("click", function(){
              var mapPoint = event.mapPoint;
              selectedLifeForm = lifeForms[1]
            });
        }
        if(Math.floor(historicTimeElapsedMillBCE)===-805){
            console.log("Adding Algae tile");
            card = document.getElementById("type3")
            card.setAttribute("src","assets/tiles/Algae.png")
            card.className += "animalDiv "; 
            card.className += "animalCard"; 
            document.getElementById("type1").addEventListener("click", function(){
              var mapPoint = event.mapPoint;
              selectedLifeForm = lifeForms[2]
            });

        }
        if(Math.floor(historicTimeElapsedMillBCE)===-500){
            console.log("Adding JellyFish tile");
            card = document.getElementById("type4")
            card.setAttribute("src","assets/tiles/Jellyfish.png")
            card.className += "animalDiv "; 
            card.className += "animalCard"; 
            document.getElementById("type1").addEventListener("click", function(){
              var mapPoint = event.mapPoint;
              selectedLifeForm = lifeForms[3]
            });

        }
        if(Math.floor(historicTimeElapsedMillBCE)===-400){
            console.log("Adding Insect tile");
            card = document.getElementById("type1")
            card.setAttribute("src","assets/tiles/Beetle.png")
            card.className += "animalDiv "; 
            card.className += "animalCard"; 
            document.getElementById("type1").addEventListener("click", function(){
              var mapPoint = event.mapPoint;
              selectedLifeForm = lifeForms[4]
            });
        }
        if(Math.floor(historicTimeElapsedMillBCE)===-350){
            console.log("Adding Fish tile");
            card = document.getElementById("type2")
            card.setAttribute("src","assets/tiles/Shark.png")
            card.className += "animalDiv "; 
            card.className += "animalCard"; 
            document.getElementById("type1").addEventListener("click", function(){
              var mapPoint = event.mapPoint;
              selectedLifeForm = lifeForms[5]
            });
        }
        if(Math.floor(historicTimeElapsedMillBCE)===-350){
            console.log("Adding Trees tile");
            card = document.getElementById("type3")
            card.setAttribute("src","assets/tiles/Fern.png")
            card.className += "animalDiv "; 
            card.className += "animalCard"; 
            document.getElementById("type1").addEventListener("click", function(){
              var mapPoint = event.mapPoint;
              selectedLifeForm = lifeForms[6]
            });
        }
        if(Math.floor(historicTimeElapsedMillBCE)===-225){
            console.log("Adding Dino tile");
            card = document.getElementById("type4")
            card.setAttribute("src","assets/tiles/Stegosaurus.png")
            card.className += "animalDiv "; 
            card.className += "animalCard";
            document.getElementById("type1").addEventListener("click", function(){
              var mapPoint = event.mapPoint;
              selectedLifeForm = lifeForms[7]
            });
        }
        if(Math.floor(historicTimeElapsedMillBCE)===-225){
            console.log("Adding Pig tile");
            card = document.getElementById("type1")
            card.setAttribute("src","assets/tiles/Pig.png")
            card.className += "animalDiv "; 
            card.className += "animalCard"; 
            document.getElementById("type1").addEventListener("click", function(){
              var mapPoint = event.mapPoint;
              selectedLifeForm = lifeForms[8]
            });
        }
        if(Math.floor(historicTimeElapsedMillBCE)===-66){
            console.log("Adding Birds tile");
            card = document.getElementById("type2")
            card.setAttribute("src","assets/tiles/Parrot.png")
            card.className += "animalDiv "; 
            card.className += "animalCard"; 
            document.getElementById("type1").addEventListener("click", function(){
              var mapPoint = event.mapPoint;
              selectedLifeForm = lifeForms[9]
            });
        }
        if(Math.floor(historicTimeElapsedMillBCE)===-55){
            console.log("Adding Primates tile");
            card = document.getElementById("type3")
            card.setAttribute("src","assets/tiles/Primate.png")
            card.className += "animalDiv "; 
            card.className += "animalCard"; 
            document.getElementById("type1").addEventListener("click", function(){
              var mapPoint = event.mapPoint;
              selectedLifeForm = lifeForms[10]
            });
        }
    }

function PopulationExplosionAfterExtinctions() {
    console.log("Population Explosion After Extinctions")
    var tempCreatures = [];
    for( i=0; i <createdLandLife.length; i++) {
        var tempCreature = createdLandLife[i];

        var topCreature = CreateNewPoint(tempCreature.geometry.x,
                                         tempCreature.geometry.y - 5,
                                         tempCreature.symbol.url);

        map.findLayerById("land-graphics-layer").add(topCreature);
        /*map.findLayerById("land-graphics-layer").add(bottomCreature);*/
        
        tempCreatures.push(topCreature);
        /*tempCreatures.push(bottomCreature);*/
    } 

    for(j=0;j < tempCreatures.length; j++) {
      createdLandLife.push(tempCreatures[j]);
    }
}

function TriggerExtinction(threshold) {
  
    console.log("Removing " + threshold + "% of Creatures");

    var creaturesToKill = Math.floor(createdLandLife.length) * threshold / 100;

    // This next part marks the number of creature to be removed
    // Initially the creatures icon is Set to Skull'n'Bones
    for(internalcounter = 0; internalcounter < creaturesToKill; internalcounter++) {
        var tempGraphic = createdLandLife.pop();
        creaturesToRemove.push(tempGraphic);
        tempGraphic.symbol.url = "assets/icons/skull.png";
        map.findLayerById("land-graphics-layer").remove(tempGraphic);
        map.findLayerById("land-graphics-layer").add(tempGraphic);
    }

    //After 3 Seconds remove the creatures marked for deletion
    setTimeout(function() { 
            for(; internalcounter >=0 ; internalcounter--) {
                  map.findLayerById("land-graphics-layer").remove(creaturesToRemove.pop());
            }
            console.log("Deleting !!");
    }, 3000);
}
    /* END GAME ENGINE */

    /* LAND/SEA GRAPHICS LAYER SECTION*/      
    // When the user clicks add the point on Map
    view.on(["click"], function(event) {
        var mapPoint = event.mapPoint;

        console.log("Point clicked    " + mapPoint.x + "," + mapPoint.y);

        var pointGraphic = CreateNewPoint(mapPoint.x,mapPoint.y,selectedLifeForm["iconUrls"][0]);

        map.findLayerById("land-graphics-layer").add(pointGraphic);
        
        checkIsLand(mapPoint).then((isLand) => {
            console.log(isLand);
            console.log(selectedLifeForm);
            var isOcean = !isLand;
            if(selectedLifeForm.isLand !== isLand || selectedLifeForm.isOcean !== isOcean){
                map.findLayerById("land-graphics-layer").remove(pointGraphic);
            }
            else{
                createdLandLife.push(pointGraphic);
            }
        }) 
    });
    /* END LAND/SEA GRAPHICS LAYER SECTION*/

    /* ANNOUNCEMENT SECTION */
  function AddAnnouncements(index) {  
      var img = document.createElement('img');
      img.setAttribute("id", "announcement");
      img.src = "assets/announce/Announcement"+index+".png";
      document.getElementById('announce').appendChild(img); 
  }  

  function RemoveAnnouncements(index) {
      var img = document.getElementById('announcement');
      img.parentNode.removeChild(img);       
  }  
    /* END ANNOUNCEMENT SECTION */ 
    /* END ARCGIS JS API SECTION */

  /* START THE GAME */
    startGame();
  /* END START THE GAME SECTION */
  });
/*END ALL USER CODE*/
var i = 0;
setInterval(function(){
}, 1000);    

</script>

  </head>

  <body>
    <div id="container">
        
        <div id="gameStatsDiv">
            <div style="width:100%;height:10%;">  <input type="range" min="-4000" max="0" value="-4000" class="myslider"></div>
            <div id="mapViewDiv"></div>
            <div id="examplePopup">
                <div id="animalsTab">
                    <input id="type1" class="" type="image" src="" alt=""/>
                    <input id="type2" class="" type="image" src="" alt="" />
                    <input id="type3" class="" type="image" src="" alt="" />
                    <input id="type4" class="" type="image" src="" alt="" />              
                </div>
            </div>
            <div id="announce">
            </div>
        </div>
    </div>
  </body>
</html>
